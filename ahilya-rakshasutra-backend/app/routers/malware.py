# app/routers/malware.py
from fastapi import APIRouter, Query
from typing import List, Optional
from app.malware_predictor import APKMalwarePredictor

router = APIRouter(prefix="/malware", tags=["malware"])
predictor = APKMalwarePredictor()

@router.get("/list-apks")
def list_apks():
    from app.malware_predictor import UPLOAD_DIR
    if not UPLOAD_DIR.exists():
        return {"apks": [], "error": f"Upload dir not found: {UPLOAD_DIR}"}
    apks = sorted([p.name for p in UPLOAD_DIR.iterdir() if p.suffix.lower() == ".apk"])
    return {"apks": apks, "count": len(apks)}

@router.post("/scan-file")
def scan_file(filename: str, detailed: bool = False):
    return predictor.predict_single(filename, detailed=detailed) or {"error": "Unknown error"}

@router.post("/scan-all")
def scan_all(detailed: bool = False):
    return {"results": predictor.predict_all(detailed=detailed)}

@router.get("/models-health")
def models_health():
    from app.malware_predictor import MODEL_FILE, SCALER_FILE, FEATURES_FILE
    def ok(p): return p.exists()
    return {
        "model_file": str(MODEL_FILE),
        "model_loaded": ok(MODEL_FILE),
        "scaler_file": str(SCALER_FILE),
        "scaler_loaded": ok(SCALER_FILE),
        "features_file": str(FEATURES_FILE),
        "features_loaded": ok(FEATURES_FILE),
    }
